<h1>A Guide to Setting up OpenAFS with Kerberos on Debian for The University of Michigan</h1>
<h2>I. Introduction</h2>
<h3>1. What is AFS</h3>
<p>Andrew File System (AFS) is the name of a program written by Transarc Corporation which was acquired by IBM. It implements a distribued filesystem, meaning a filesystem that is distributed across many computers. IBM made a copy of the program's code available for open development and this release is called OpenAFS.</p>
<p>U-M uses OpenAFS to store the files in your CAEN home directory. You can verify this by ssh-ing into a CAEN machine and finding the directory <code>/afs/umich.edu/user/j/m/jminjie/</code> and comparing its conents to <code>~/</code>. When OpenAFS is installed, the program abstracts away the actual distributing work being done and mounts the file system in <code>/afs</code> so that your files can be read as if they were on disk. Then the computer you ssh into at <code>login.engin.umich.edu</code> pretends that the <code>/afs</code> directory belonging to your uniqname is your home directory.</p>
<h3>2. Why use AFS</h3>
<p>For most of my U-M EECS undergraduate career my workflow consisted of editing files on my computer using my preferred text editors, transferring the files to my CAEN home directory using WinSCP or git, and compiling on CAEN.</p>
<p>With this set up you will be able to edit files as if they were on your own disk and your changes will propogate so that anyone using OpenAFS to view them will see the changes. That means the new workflow consists of just editing and then compiling on CAEN.</p>
<h3>3. What is Kerberos</h3>
<p>OpenAFS uses Kerberos for authentication. Just like when you log in to Wolverine Access, CTools or Canvas, the authentication ticket you receive is good for a whole bunch of different U-M services. We need to use Kerberos together with OpenAFS because we don't own the filesystem at <code>umich.edu</code>, the school does.</p>
<h2>II. Setting up Kerberos</h2>
First we use the Debian package manager <code>apt-get</code> to install krb5-user, the user client for Kerberos. Using this program takes some configuration, but instead of doing it manually we can use <code>scp</code> to copy the the configuration file from the CAEN computers. Finally we can run <code>kinit</code> and then <code>klist</code> to get a ticket and then verify that we've gotten it. Altogether the commands are:
<pre><code>sudo apt-get install krb5-user
scp jminjie@login.engin.umich.edu:/etc/krb5.conf temp.txt
sudo mv temp.txt /etc/krb5.conf
kinit jminjie@UMICH.EDU
klist
</code></pre>
If we stop and look at the contents of temp.txt, the copied configuration file, we see the description of a realm being defined as the default realm called UMICH.edu. Specific servers and ports are listed which tell Kerberos exactly how to get authentication when we run <code>kinit</code>.
<h2>III. Setting up AFS</h2>
First we install the necessary packages to run OpenAFS with Kerberos. Dynamic Kernel Module Support (DKMS) is a supplementary package that helps install kernel modules. Once the packages are installed we use DKMS to configure the installation settings for OpenAFS with Kerberos.
<pre><code>sudo apt-get install openafs-client openafs-krb5 openafs-modules-dkms
sudo dpkg-reconfigure krb5-config openafs-client</code></pre>
<p>Running dpkg-reconfigure will open a window in which you should choose these options:</p>
<pre>
Default realm:	                                             UMICH.EDU
Does DNS contain pointers to your realm's Kerberos Servers?  Yes
AFS cell this workstation belongs to:                        umich.edu
Size of AFS cache:                                           512000 (this means 0.5GB, and can be higher if you have the space. All students at U-M get 10GB max.)
Run openafs client now and at boot?                          (user preference)
Look up AFS cells in DNS?                                    Yes
Encrypt authenticated traffic with AFS fileserver?           Yes
Dynamically generate the contents of /afs                    Yes
Use fakestat?                                                Yes
DB server host names for your home cell:                     (blank)
Run openafs client now and at boot?                          (user preference)
</pre>
Once this is finished, we once again copy the configuration file from the CAEN computers using scp. If we stop here and read the contents of temp.txt we see a large list of entries indexed by server name. At the top of the list is eecs.umich.edu, some IP addresses and afs server names. This file combined with some others in <code>/etc/openafs/</code> tell the <code>aklog</code> command how to turn an acquired Kerberos ticket into an OpenAFS token. Finally we verify that we have acquired the token by running <code>token</code>.
<pre><code>scp jminjie@login.engin.umich.edu:/etc/openafs/CellServDB temp.txt
sudo mv temp.txt /etc/openafs/CellServDB
aklog
tokens
</code></pre>
<h2> IV. Putting it all together</h2>
<body>
I explain how to put it all together
<pre><code>
$ chmod +x init_afs
$ cat init_afs
#!/bin/sh
kinit jminjie@UMICH.EDU
klist
aklog
tokens
cd  /afs/umich.edu/user/j/m/jminjie
</code></pre>
I made a shell script called init_afs. You could run it using <code>./init_afs</code> but since this would open up a temporary shell and execute it, and I want the script to change my directory, I invoke it with <code>source init_afs</code> instead.
</body>
<h2>V. Resources</h2>
<body>
These are the resources I used:<br>
http://csw.github.io/bioruby-maf/blog/2012/09/26/ssh_kerberos_umich/<br>
http://tig.csail.mit.edu/wiki/TIG/OpenAFSOnUbuntuLinux<br>
</body>
